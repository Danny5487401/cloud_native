<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

- [github.com/kubernetes/code-generator](#githubcomkubernetescode-generator)
  - [标记（Tags）](#%E6%A0%87%E8%AE%B0tags)
  - [client-gen](#client-gen)
  - [lister-gen 代码生成器](#lister-gen-%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8)
  - [informer-gen 代码生成器](#informer-gen-%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8)
  - [deepcopy-gen](#deepcopy-gen)
  - [defaulter-gen 代码生成器](#defaulter-gen-%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8)
  - [应用](#%E5%BA%94%E7%94%A8)
  - [参考](#%E5%8F%82%E8%80%83)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->



# github.com/kubernetes/code-generator

[主要工具](https://github.com/kubernetes/code-generator/tree/v0.32.3/cmd)
- applyconfiguration-gen：为CRD生成apply配置文件代码。
- client-gen：生成客户端代码
- conversion-gen：生成对象间转换需要的conversion函数，方便在不同版本之间进行对象转换。
- deepcopy-gen：为每个T类型生成func (t* T) DeepCopy() *T方法，API类型都需要实现深拷贝，在客户端和服务器之间交换数据时，需要独立的数据副本。
- defaulter-gen：生成设置默认值的方法，如果某些字段未设置，则自动填充默认值。
- go-to-protobuf：将Go语言对象转换为Protobuf定义。Protobuf 是一种高效的二进制序列化格式，用于优化 Kubernetes API 性能。
- informer-gen：为 listwatch 生成 shared informer代码。
- lister-gen：生成lister代码。Listers 为get和list请求提供只读缓存层（通过indexer获取），可以实现高效的资源列表查询。
- prerelease-lifecycle-gen：生成API生命周期的代码，如标记API的alpha、beta、stable状态等，用于管理API版本的生命周期。
- register-gen：生成API注册代码，包括资源类型和其对应的API组版本的注册信息



如果要开发CRD，经常用到的是deepcopy-gen和register-gen。
如果要开发apiserver，则还会经常用到defaulter-gen，conversion-gen，go-to-protobuf。
无论通过CRD还是apiserver，都可能要为API生成客户端，也就会用到applyconfiguration-gen，client-gen，lister-gen，informer-gen。


## 标记（Tags）

标记（Tags）是用来指导代码生成过程的特殊注释。这些标记可以在你的Go源代码中直接使用，告诉code-generator如何生成特定的代码。code-generator中的tag分为global tags和local tags。

- global tags: 全局的tag，位于具体版本的doc.go文件中。
- local tags: 本地的tag，位于types.go文件中的struct上
  使用方法有两种：
```go
// +tagName
// +tagName=value
```


## client-gen 
client-gen代码生成器是一种为资源生成ClientSet客户端的工具。
ClientSet对Group（资源组）、Version（资源版本）、Resource（资源）进行了封装，可以针对资源执行生成资源操作方法（create、update、delete、get等），这些方法由client-gen代码生成器自动生成。
```shell
(⎈|kubeasz-test:kruise-test)➜  git_download client-gen --help
Usage of client-gen:
      --add_dir_header                       If true, adds the file directory to the header of the log messages
      --alsologtostderr                      log to standard error as well as files (no effect when -logtostderr=true)
      --apply-configuration-package string   optional package of apply configurations, generated by applyconfiguration-gen, that are required to generate Apply functions for each type in the clientset. By default Apply functions are not generated.
      --clientset-api-path string            the value of default API HTTP path, starting with / and without trailing /. (default "/apis")
  -n, --clientset-name string                the name of the generated clientset package. (default "internalclientset")
      --clientset-only                       when set, client-gen only generates the clientset shell, without generating the individual typed clients
      --fake-clientset                       when set, client-gen will generate the fake clientset that can be used in tests (default true)
      --go-header-file string                the path to a file containing boilerplate header text; the string "YEAR" will be replaced with the current 4-digit year
      --included-types-overrides strings     list of group/version/type for which client should be generated. By default, client is generated for all types which have genclient in types.go. This overrides that. For each groupVersion in this list, only the types mentioned here will be included. The default check of genclient will be used for other group versions. (default [])
      --input strings                        group/versions that client-gen will generate clients for. At most one version per group is allowed. Specified in the format "group1/version1,group2/version2...". (default [])
      --input-base string                    base path to look for the api group. (default "k8s.io/kubernetes/pkg/apis")
      --log_backtrace_at traceLocation       when logging hits line file:N, emit a stack trace (default :0)
      --log_dir string                       If non-empty, write log files in this directory (no effect when -logtostderr=true)
      --log_file string                      If non-empty, use this log file (no effect when -logtostderr=true)
      --log_file_max_size uint               Defines the maximum size a log file can grow to (no effect when -logtostderr=true). Unit is megabytes. If the value is 0, the maximum file size is unlimited. (default 1800)
      --logtostderr                          log to standard error instead of files (default true)
      --one_output                           If true, only write logs to their native severity level (vs also writing to each lower severity level; no effect when -logtostderr=true)
      --output-dir string                    the base directory under which to generate results
      --output-pkg string                    the Go import-path of the generated results
      --plural-exceptions strings            list of comma separated plural exception definitions in Type:PluralizedType form
      --prefers-protobuf                     when set, client-gen will generate a clientset that uses protobuf for API requests
      --skip_headers                         If true, avoid header prefixes in the log messages
      --skip_log_headers                     If true, avoid headers when opening log files (no effect when -logtostderr=true)
      --stderrthreshold severity             logs at or above this threshold go to stderr when writing to files and stderr (no effect when -logtostderr=true or -alsologtostderr=true) (default 2)
  -v, --v Level                              number for the log level verbosity
      --vmodule moduleSpec                   comma-separated list of pattern=N settings for file-filtered logging
pflag: help requested
```
```go
// 生成基本的资源操作方法（Verbs），例如create、update、delete、get、list、patch、watch等方法。另外，如果存在Status字段，则生成UpdateStatus函数。
//+genclient

// 生成基本的资源操作函数，不生成Namespaced函数。
//+genclient:nonNamespaced

// 即便存在Status字段，也不生成UpdateStatus函数。
//+genclient:noStatus

// 不生成基本的资源操作方法（Verbs）
//+genclient:noVerbs

// 仅生成指定的基本操作方法，例如create、get方法。
//+genclient:onlyVerbs=create,get

// 生成基本的资源操作方法（Verbs），但排除watch方法
//+genclient:skipVerbs=watch

// 生成相关扩展（Extensions）函数，例如生成UpdateScale函数。在UpdateScale函数中会对scale子资源进行update（更新）操作。input和result是用于设置输入和输出的参数。
//+genclient:method=UpdateScale,verbs=update,subresource=scale,input =Scale,result=Scale
```


## lister-gen 代码生成器
lister-gen代码生成器是一种为资源生成Lister的工具。
Lister为每一个Kubernetes资源提供Lister功能（即提供get和list方法）。get和list方法为客户端提供只读的本地缓存数据。以上功能由lister-gen代码生成器自动生成。

## informer-gen 代码生成器
informer-gen代码生成器是一种为资源生成Informer的工具。Informer为client-go提供了与Kubernetes API Server通信的机制，这些功能由informer-gen代码生成器自动生成
```go
//+k8s:informers：使用informer-gen必须要写这一行。
//+k8s:informers:groupVersion=${group}/${version}：指定生成的Informer代码对应的API组和版本。
//+k8s:informers:internalVersion=internal/version：指定生成的Informer代码对应的内部API版本。
//+k8s:informers:versionedClientSet=false：指定生成的Informer代码是否需要为版本化的客户端集（Versioned ClientSet）生成代码。
//+k8s:informers:cache：指定生成的Informer代码是否需要使用缓存。
```

## deepcopy-gen
- deepcopy-gen 是一个自动生成 zz_generated.deepcopy.go 文件的代码生成器。
- zz_generated.deepcopy.go 文件主要包括两个函数，DeepCopy() 和 DeepCopyInto()，功能就是深度拷贝，也就是生成一个相同的结构体，两个内存空间。
```go
//+k8s:deepcopy-gen=<arguments>: 这是控制深拷贝方法生成的主要标记。它可以接受不同的参数来指导生成过程。例如，当设置为interfaces时，可以指定某个类型实现了自定义的深拷贝接口。
//+k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object: 这个标记指定类型应该实现Kubernetes的runtime.Object接口，它需要有自己的深拷贝方法。
//+k8s:deepcopy-gen=false: 使用这个标记可以排除某些类型或字段不生成深拷贝方法。这对于那些不需要深拷贝或者深拷贝逻辑需要自定义实现的情况非常有用。
//+k8s:deepcopy-gen=package: 这个标记放在包的doc.go文件中，表示为该包中的所有类型生成深拷贝方法，除非另外指定
```


## defaulter-gen 代码生成器
- defaulter-gen 是一个自动生成 zz_generated.defaults.go 文件的代码生成器。
- zz_generated.defaults.go 文件主要功能就是为资源对象生成默认值。每一个对象会生成一个专门的函数，xxxTypeDefaults() ，用于给对象幅默认值。
```go
//+k8s:defaulter-gen=TypeMeta: 为拥有 TypeMeta 属性的类型生成Defaulter相关函数
//+k8s:defaulter-gen=ListMeta : 为拥有 ListMeta 属性的类型生成Defaulter相关函数
//+k8s:defaulter-gen=ObjectMeta : 为拥有 ObjectMeta 属性的类型生成Defaulter相关函数
//+k8s:defaulter-gen-input=path/to/package : 当前包会依赖于指定的路径包
```




## 应用

前置条件
```shell
$ git clone https://github.com/kubernetes/code-generator.git
$ git clone https://github.com/kubernetes/sample-controller
$ ls ./{sample-controller,code-generator} 
./code-generator:
CONTRIBUTING.md             SECURITY_CONTACTS           examples                    go.sum                      tools.go
LICENSE                     cmd                         generate-groups.sh          kube_codegen.sh
OWNERS                      code-of-conduct.md          generate-internal-groups.sh pkg
README.md                   doc.go                      go.mod                      third_party

./sample-controller:
CONTRIBUTING.md    OWNERS             SECURITY_CONTACTS  code-of-conduct.md controller_test.go go.mod             hack               pkg
LICENSE            README.md          artifacts          controller.go      docs               go.sum             main.go


```


## 参考
- [code-generator介绍](https://wghdr.top/?p=4124)
- https://blog.51cto.com/daixuan/5175780
- [k8s构建方式和代码生成器](https://www.guoshaohe.com/cloud-computing/kubernetes-source-read/1320)